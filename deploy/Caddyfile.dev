# ==========================================
# Caddy Dev 환경 설정
# dev-blogs.shaul.link
# ==========================================

# 글로벌 설정
{
    # 이메일 (Let's Encrypt 인증서용)
    email admin@shaul.link

    # HTTPS 자동 설정
    auto_https on

    # 로깅
    log {
        output file /var/log/caddy/access.log
        format json
    }
}

# dev-blogs.shaul.link 도메인
dev-blogs.shaul.link {
    # 압축
    encode gzip zstd

    # 로그
    log {
        output file /var/log/caddy/dev-blogs.shaul.link.log
        format json
    }

    # 리버스 프록시 (Dev 컨테이너 - 포트 10100)
    reverse_proxy localhost:10100 {
        # 헬스체크
        health_uri /up
        health_interval 10s
        health_timeout 5s
        health_status 200

        # 헤더 설정
        header_up Host {host}
        header_up X-Real-IP {remote_host}
        header_up X-Forwarded-For {remote_host}
        header_up X-Forwarded-Proto {scheme}

        # 타임아웃
        transport http {
            dial_timeout 30s
            read_timeout 60s
            write_timeout 60s
        }
    }

    # 보안 헤더
    header {
        # XSS 보호
        X-XSS-Protection "1; mode=block"
        # Content-Type 스니핑 방지
        X-Content-Type-Options "nosniff"
        # 클릭재킹 방지
        X-Frame-Options "SAMEORIGIN"
        # HTTPS 강제
        Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
        # 리퍼러 정책
        Referrer-Policy "strict-origin-when-cross-origin"
        # 권한 정책
        Permissions-Policy "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()"
        # 서버 정보 숨김
        -Server
    }

    # 정적 파일 캐싱
    @static {
        path *.js *.css *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2 *.ttf *.eot
    }
    header @static Cache-Control "public, max-age=31536000, immutable"

    # robots.txt (Dev 환경은 크롤링 차단)
    handle /robots.txt {
        respond "User-agent: *\nDisallow: /"
    }

    # favicon
    handle /favicon.ico {
        file_server
        root * /var/www/laravel-commu-dev/public
    }
}

# www 리다이렉트
www.dev-blogs.shaul.link {
    redir https://dev-blogs.shaul.link{uri} permanent
}
